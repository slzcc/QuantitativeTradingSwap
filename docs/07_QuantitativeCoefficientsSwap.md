## 07_QuantitativeCoefficientsSwap

> 当脚本启动时需要通过 127.0.0.1:6379 进行连接, 可以通过 `python3 07_QuantitativeCoefficientsSwap.py --help` 连接 redis 所需启动配置参数. 

基于系数 `ETH/BTC` 币对进行交易, 当前脚本启动时, 基于合约下单 `ETH/USDT` 和 `BTC/USDT` 开多开空基于 `ETH/BTC` 的阀值。

启动命令:

```
$ python3 07_QuantitativeCoefficientsSwap.py --key xx --secret xx --token g452bLCV8GcoWZq --rauth 'oM3K/+DoUyetI16Rerc7wo'
```

### 暂停下单

当需要暂停后续下单需修改 redis 中的 `<token>_order_pause_coefficient` key 修改为 `true` 就会暂停后续下单。

> 暂停下单后不会影响当前的自动平仓.

### 强制平仓

当需要强制平仓可以修改 redis 中的 `<token>_forced_liquidation_coefficient` key 修改为 `true` 就会平仓。

> 平仓后会等待 5 秒继续下单, 如不在需要下单请于 `暂停下单` 同时启用.


### 架构设计


```
|———————0、run(主进程)
|           |
|           |——0.1 创建 trade 对象(api 接口对象)
|           |——0.2 修改全仓模式
|           |——0.3 修改开仓杠杆
|           |——0.4 获取 BTC/USDT 合约最新价格(子进程1)
|           |——0.5 获取 ETH/USDT 合约最新价格(子进程2)
|           |——0.6 获取 ETH/BTC  现货最新价格(子进程3)
|           |——0.7 判定 ETH/BTC  现货最新价格是否 大于/小于 _long_short_trend_(redis) 值(设置方向, 子进程4)
|           |
|       1、while true(死循环)
|           |
|           |
|       2、平仓模式阻止建仓(目的当进行平仓时不允许建仓)
|           |
|           |
|       3、单币模式
|           |
|           |——3.1 是否打开强制平仓开关，如果是进行强制平仓不关心盈亏
|           |
|           |——3.2 进入手动模式
|           |
|           |——3.3 判定是否空仓
|           |         |
|           |         |——3.3.1 如果订单中存在双币池, 且单币开关打开状态, 需要把单币开关进行关闭
|           |         |
|           |         |——3.3.2 下单逻辑
|           |         |      |
|           |         |      |——3.3.2.1 停止下单开关
|           |         |      |——3.3.2.2 获取最新下单 USDT 数量
|           |         |      |——3.3.2.3 USDT 转换 ETH 数量
|           |         |      |——3.3.2.4 获取 ETH 开仓方向
|           |         |      |——3.3.2.5 创建订单(ETH 建仓)
|           |         |
|           |         |——3.3.3 持有仓位逻辑
|           |                |
|           |                |——3.3.3.1 获取当前收益
|           |                |——3.3.3.2 判断当前盈亏比 > (profit * 3)% 进行清仓(盈利)
|           |                |——3.3.3.3 判断当前盈亏比 > (loss)% 进行补仓 或 开双币(亏损)
|           |                               |
|           |                               |——3.3.3.3.1 获取委托数量
|           |                               |——3.3.3.3.2 初始化变量
|           |                               |——3.3.3.3.3 判断是否打开亏损加仓模式
|           |                               |                 |
|           |                               |                 |——3.3.3.3.3.1 当前加仓数量到达上限
|           |                               |                 |            |
|           |                               |                 |            |——3.3.3.3.3.1.1 计算所有加仓额度
|           |                               |                 |
|           |                               |                 |——3.3.3.3.3.2 当前加仓数量未达上限
|           |                               |                              |
|           |                               |                              |——3.3.3.3.3.1.2.1 计算委托数量(BTC)
|           |                               |                              |——3.3.3.3.1.1.2.2 BTC 数量转换 ETH
|           |                               |                              |——3.3.3.3.1.1.2.3 创建订单(ETH 补仓)
|           |                               |                              |——3.3.3.3.1.1.2.4 加仓次数累加(不会走 3.3.3.3.4 之后的逻辑)
|           |                               |
|           |                               |——3.3.3.3.4 开双币, 获取 ETH 方向
|           |                               |——3.3.3.3.5 创建订单(BTC 双币建仓)
|           |
|           |
|       4、双币模式
|           |
|           |——4.1 是否打开强制平仓开关，如果是进行强制平仓不关心盈亏
|           |
|           |——4.2 进入手动模式
|           |
|           |——4.3 判定是否空仓
|           |        |
|           |        |——4.3.1 获取委托数量
|           |        |——4.3.2 停止下单逻辑
|           |        |         |
|           |        |         |——4.3.2.1 一直阻塞(sleep 5), 直到 redis 数据变更
|           |        |
|           |        |——4.3.3 获取 BTC 方向
|           |        |——4.3.4 创建订单(BTC 双币建仓)
|           |        |——4.3.5 BTC 数量转换 ETH
|           |        |——4.3.6 创建订单(ETH 双币建仓)
|           |
|           |——4.4 持仓模式
|                  |
|                  |——4.4.1 获取 ETH 和 BTC 开单方向
|                  |——4.4.2 计算 BTC 和 ETH 收益
|                  |——4.4.3 (BTC + ETH) 收益大于 profit 时, 平仓(ETH,BTC) 
|                  |——4.4.4 双币亏损加仓模式(未实现)
|                  |——4.4.5 持续监听
```